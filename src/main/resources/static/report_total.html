<meta charset="utf-8"/>
<div class="row">
    <div class="col-xs-12">
        <div class="row">
            <div class="col-xs-12">
                <div class="clearfix">
                    <table class="no-border" style="display:inline">
                        <tr>
                            <td class="hidden-480" style="padding: 0px 6px;">
                                登记日期
                            </td>
                            <td>
                                <div class="input-group">
                                    <input type="text" id="crowd_date" class="form-control search-query date-picker" placeholder="选择日期" style="width:90px;" data-date-format="yyyy-mm-dd"/>
                                </div>
                            </td>
                            <td style="padding: 0px 6px;">
                                区域位置
                            </td>
                            <td>
                                <div class="input-group">
                                    <div id="environmentSearch" style="">
                                        <select class="clsProvince" id="key_province_id" style="height:34px;cursor:pointer;margin-top:-1px;" onchange="thisPage.getAreaData(this.value,'#environmentSearch','.clsCity','请选择省|市');"><option value=''>请选择省|市</option></select>
                                        <select class="clsCity" id="key_city_id" style="display:none;margin-top:4px;height:34px;cursor:pointer;margin-top:-4px;" onchange="thisPage.getAreaData(this.value,'#environmentSearch','.clsCounty','请选择地州市');"><option value=''></option></select>
                                        <select class="clsCounty" id="key_county_id" style="display:none;margin-top:4px;height:34px;cursor:pointer;margin-top:-8px;" onchange="thisPage.getAreaData(this.value,'#environmentSearch','.clsTowns','请选择区|县');"><option value=''></option></select>
                                    </div>
                                </div>
                            </td>
                            <td style="padding-left:6px;">
                                <div class="input-group">
                                    <span class="input-group-btn">
                                        <button type="button" class="btn btn-inverse btn-white" id="btnSearch" permission='reportTotal_btn_getView' style="display:none">
                                            <span class="fa fa-eye bigger-110"></span>
                                            查看
                                        </button>
                                    </span>
                                </div>
                            </td>
                            <td>
                                <div class="input-group">
                                    <span class="input-group-btn">
                                        <button type="button" class="btn btn-inverse btn-white" id="btnExport" permission='reportTotal_btn_export' style="display:none">
                                            <span class="fa fa-download"></span>
                                            导出
                                        </button>
                                    </span>
                                </div>
                            </td>
                        </tr>
                    </table>
                    <div class="col-xs-12" style="display:flex;justify-content:center;align-items:center;padding:6px 0;border-top:1px solid #eee;border-bottom:1px solid #eee;margin-top:2px;">
                        <label style="font-size:22px;" id="labelShow">核酸日报表 (0:00-24:00)</label>
                    </div>
                    <div class="col-xs-12" style="display:flex;justify-content:center;padding-top:4px;">
                        <table id="containerTabel" style="border-spacing:0px 10px;font-size:14px;"></table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<script type="text/javascript">
    $(function(){
        var urlRoute = '/reportTotal/';/*请求controller层的url*/
        var urlGetView = urlRoute + 'getView';/*查看报表*/
        var urlQueryAreaSelect = urlRoute + 'queryAreaSelect';/*获取区域数据*/
        var urlQueryPermissions = urlRoute + 'queryPermissions';
        var urlExportExcel = urlRoute + 'exportExcel';/*导出Excel*/
        thisPage = {
            init : function(){
                winFn.initDate();
                this.addEvent();
                this.initDom();
                this.permissions();
                thisPage.viewReport(1);
            },
            initDom : function(){
                thisPage.getAreaData('0','#environmentSearch','.clsProvince','选择省|市');
            },
            getAreaData : function(pid,containerDom,selectDom,labelText){
                selectArea.getData(urlQueryAreaSelect,pid,containerDom,selectDom,labelText);
            },
            addEvent : function(){
                this.btnEvent();
            },
            permissions : function(){
                layerFn.ajaxGetResult(urlQueryPermissions,{},(result)=>{
                    var {code,data} = result;
                    if(code === AppKey.code.code200){
                        for(var i=0;i<data.length;i++){
                            $("[permission='"+data[i]+"']").css({"display":"inline"});
                        }
                    }
                });
            },
            getSelectLabel : function(){
                this.showLabel(winFn.select.getText('#key_province_id'),winFn.select.getText('#key_city_id'),winFn.select.getText('#key_county_id'),winFn.getDomValue('#crowd_date'));
            },
            btnEvent : function(){
                $('#btnSearch').on('click',function(){
                    thisPage.viewReport();
                });
                $('#btnExport').on('click',function(){
                    thisPage.exportExcel();
                });
            },
            showLabel : function(province,city,county,date){
                var label = '';
                if(province){
                    label += province;
                }
                if(city){
                    label += city;
                }
                if(county){
                    label += county;
                }
                var _date = '';
                if(date){
                    _date += date;
                }
                label += '核酸日报表'+_date+' (0:00-24:00)';
                $('#labelShow').text(label);
            },
            viewReport : function(type){
                var params = {
                    province_id : winFn.getDomValue('#key_province_id'),
                    city_id : winFn.getDomValue('#key_city_id'),
                    county_id : winFn.getDomValue('#key_county_id'),
                    crowd_date : winFn.getDomValue('#crowd_date')
                };
                var _this = this;
                layerFn.queryGetHintResult(urlGetView,params,(data)=>{
                    _this.getSelectLabel();
                    if(data.code === AppKey.code.code200){
                        _this.renderTable(data.data);
                    }else if(data.code === AppKey.code.code201){
                        if(type){
                            _this.otherData('当日没有数据,请换个日期试试');
                        }else{
                            _this.otherData('暂无数据,请换个日期试试');
                        }
                    }else{
                        _this.otherData(data.msg);
                    }
                });
            },
            exportExcel : function(){
                var url = urlExportExcel+'?&crowd_date='+$("#crowd_date").val()+
                '&province_id='+$("#key_province_id").val()+
                '&province_text='+$("#key_province_id").find("option:selected").text()+
                '&city_id='+$("#key_city_id").val()+
                '&city_text='+$("#key_city_id").find("option:selected").text()+
                '&county_id='+$("#key_county_id").val()+
                '&county_text='+$("#key_county_id").find("option:selected").text()
                layerFn.handleTop('请耐心等待,处理完成将会自动下载!',AppKey.code.code200);
                winFn.getPageHashToken(url);
            },
            otherData : function(msg){
                var html = '';
                html += '<tr>';
                html += '<td style="padding:10px 20px;border:1px solid #ddd;">'+msg+'</td>';
                html += '</tr>';
                $('#containerTabel').html(html);
            },
            renderTable : function(data){
                var _col = [];
                var columns = [];//获取分组(分类)的个数
                for(var i=0;i < data.length;i++){
                    var obj = data[i];
                    for(var key in obj){
                        if(key == 'crowdName'){
                            var _val = obj[key];
                            if(_col.indexOf(_val) === -1){
                                _col.push(_val);
                                var as = {};
                                as[key]=_val;
                                columns.push(as);
                            }
                        }
                    }
                }

                var containerTabel = 'containerTabel';
                var html = '';

                var tr = '<tr>';
                var _tr = '</tr>';

                //第1行,列数,分类[分组]-开始
                html += tr;
                for(var index in columns){
                    html += '<td align="center" valign="middle" style="border:1px solid #ddd;font-size:16px;padding:10px 0;">'+columns[index].crowdName+'</td>';
                }
                html += _tr;
                //第1行,列数,分类[分组]-结束

                //第2行,类型-开始
                html += tr;
                for(var index in columns){
                    var trIndex = 'dataTr'+index;
                    html += '<td align="center" id="'+trIndex+'" valign="top" style="border:1px solid #ddd;"></td>';
                }
                html += _tr;
                //第2行,类型-结束

                var totalAllsampling = 0;
                var totalAlldetection = 0;
                var totalAllmasculine = 0;
                for(var v=0;v < data.length;v++){
                    totalAllsampling += Number.parseInt(data[v].sampling);
                    totalAlldetection += Number.parseInt(data[v].detection);
                    totalAllmasculine += Number.parseInt(data[v].masculine);
                }
                //第3行,总计-开始
                html += tr;
                html += '<td colspan="'+columns.length+'" align="center" valign="middle" style="border:1px solid #ddd;">';

                html += '<table style="margin:2px 0;border-right:1px solid #ddd;background:#92D050">';
                html += '<tr>';
                html += '<td align="center" valign="middle" style="width:510px;border-right:1px solid #ddd;">核酸总计</td>';
                html += '<td style="width:510px">';
                html += '<table style="" width="100%">';
                html += '<tr>';
                html += '<td align="left" valign="middle" style="padding-left:2px;">已采样人数</td>';
                html += '<td align="right" valign="middle" style="padding-right:2px;">'+totalAllsampling+'</td>';
                html += '</tr>';
                html += '<tr>';
                html += '<td align="left" valign="middle" style="padding-left:2px;">已检测人数</td>';
                html += '<td align="right" valign="middle" style="padding-right:2px;">'+totalAlldetection+'</td>';
                html += '</tr>';
                html += '<tr>';
                html += '<td align="left" valign="middle" style="padding-left:2px;">检测阳性人数</td>';
                html += '<td align="right" valign="middle" style="padding-right:2px;">'+totalAllmasculine+'</td>';
                html += '</tr>';
                html += '</table>';
                html += '</td>';
                html += '</tr>';
                html += '</table>';

                html += '</td>';
                html += _tr;
                //第3行,总计-结束

                $('#' + containerTabel).html(html);//关键点!!!,先初始化先!!!

                var totalData = [];
                for(var index in columns){
                    var trIndex = 'tr'+index;
                    trIndex = [];
                    var value = columns[index].crowdName;
                    for(var x=0;x < data.length;x++){
                        var obj = data[x];
                        for(var key in obj){
                            if(key == 'crowdName'){
                                var _v = obj[key];
                                if(value == _v){
                                    trIndex.push(obj);
                                }
                            }
                        }
                    }
                    totalData.push(trIndex);
                }
                //类型统计显示-开始
                for(var index in columns){
                    var trIndex = 'dataTr'+index;
                    var htmlIndex = 'html'+index;
                    htmlIndex = '';
                    var _arrs = totalData[index];
                    for(var y = 0; y < _arrs.length; y++){
                        htmlIndex += '<table style="border-top:1px solid #ddd;border-bottom:1px solid #ddd;width:510px;margin:2px 0">';
                        htmlIndex += '<tr>';
                        htmlIndex += '<td align="center" valign="middle" style="width:300px;border-right:1px solid #ddd;">'+_arrs[y].crowdType+'</td>';
                        htmlIndex += '<td style="width:210px">';
                        htmlIndex += '<table style="" width="100%">';
                        htmlIndex += '<tr>';
                        htmlIndex += '<td align="left" valign="middle" style="padding-left:2px;">已采样人数</td>';
                        htmlIndex += '<td align="right" valign="middle" style="padding-right:2px;">'+_arrs[y].sampling+'</td>';
                        htmlIndex += '</tr>';
                        htmlIndex += '<tr>';
                        htmlIndex += '<td align="left" valign="middle" style="padding-left:2px;">已检测人数</td>';
                        htmlIndex += '<td align="right" valign="middle" style="padding-right:2px;">'+_arrs[y].detection+'</td>';
                        htmlIndex += '</tr>';
                        htmlIndex += '<tr>';
                        htmlIndex += '<td align="left" valign="middle" style="padding-left:2px;">检测阳性人数</td>';
                        htmlIndex += '<td align="right" valign="middle" style="padding-right:2px;">'+_arrs[y].masculine+'</td>';
                        htmlIndex += '</tr>';
                        htmlIndex += '</table>';
                        htmlIndex += '</td>';
                        htmlIndex += '</tr>';
                        htmlIndex += '</table>';
                    }
                    $('#' + trIndex).append(htmlIndex);
                }
                //类型统计显示-结束

                //各类型合计,附加第2行,类型的到末尾-开始
                for(var index in columns){
                    var trIndex = 'dataTr'+index;
                    var htmlIndex = 'html'+index;
                    htmlIndex = '';
                    var _arrs = totalData[index];

                    var totalsampling = 'totalsampling'+index;
                    var totaldetection = 'totaldetection'+index;
                    var totalmasculine = 'totalmasculine'+index;

                    totalsampling = 0;
                    totaldetection = 0;
                    totalmasculine = 0;

                    for(var y = 0; y < _arrs.length; y++){
                        totalsampling += Number.parseInt(_arrs[y].sampling);
                        totaldetection += Number.parseInt(_arrs[y].detection);
                        totalmasculine += Number.parseInt(_arrs[y].masculine);
                    }

                    var value = columns[index].crowdName;

                    htmlIndex += '<table style="border-top:1px solid #ddd;border-bottom:1px solid #ddd;width:510px;margin:2px 0;background:#92D050;">';
                    htmlIndex += '<tr>';
                    htmlIndex += '<td align="center" valign="middle" style="width:300px;border-right:1px solid #ddd;">'+value+'合计</td>';
                    htmlIndex += '<td style="width:210px">';
                    htmlIndex += '<table style="" width="100%">';
                    htmlIndex += '<tr>';
                    htmlIndex += '<td align="left" valign="middle" style="padding-left:2px;">已采样人数</td>';
                    htmlIndex += '<td align="right" valign="middle" style="padding-right:2px;">'+totalsampling+'</td>';
                    htmlIndex += '</tr>';
                    htmlIndex += '<tr>';
                    htmlIndex += '<td align="left" valign="middle" style="padding-left:2px;">已检测人数</td>';
                    htmlIndex += '<td align="right" valign="middle" style="padding-right:2px;">'+totaldetection+'</td>';
                    htmlIndex += '</tr>';
                    htmlIndex += '<tr>';
                    htmlIndex += '<td align="left" valign="middle" style="padding-left:2px;">检测阳性人数</td>';
                    htmlIndex += '<td align="right" valign="middle" style="padding-right:2px;">'+totalmasculine+'</td>';
                    htmlIndex += '</tr>';
                    htmlIndex += '</table>';
                    htmlIndex += '</td>';
                    htmlIndex += '</tr>';
                    htmlIndex += '</table>';

                    $('#' + trIndex).append(htmlIndex);
                }
                //各类型合计,附加第2行,类型的到末尾-结束
            }
        };
        thisPage.init();
    });
</script>